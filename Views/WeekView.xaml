<UserControl x:Class="OutlookCalendar.Views.WeekView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:converters="clr-namespace:OutlookCalendar.Converters"
             xmlns:behaviors="clr-namespace:OutlookCalendar.Behaviors"
             xmlns:vm="clr-namespace:OutlookCalendar.ViewModels"
             mc:Ignorable="d"
             d:DesignHeight="700" d:DesignWidth="900">

    <UserControl.Resources>
        <!-- Цвета -->
        <SolidColorBrush x:Key="BorderGray" Color="#A5ACB5"/>
        <SolidColorBrush x:Key="GridLine" Color="#D4D4D4"/>

        <LinearGradientBrush x:Key="HeaderGradient" StartPoint="0,0" EndPoint="0,1">
            <GradientStop Color="#FFFFFF" Offset="0"/>
            <GradientStop Color="#CFE4F7" Offset="0.5"/>
            <GradientStop Color="#B8CCE4" Offset="1"/>
        </LinearGradientBrush>

        <LinearGradientBrush x:Key="ToolbarGradient" StartPoint="0,0" EndPoint="0,1">
            <GradientStop Color="#FEFEFE" Offset="0"/>
            <GradientStop Color="#ECE9D8" Offset="1"/>
        </LinearGradientBrush>

        <!-- Конвертеры -->
        <converters:InverseBoolConverter x:Key="InverseBoolConverter"/>
        <converters:TimeToCanvasTopConverter x:Key="TimeToCanvasTopConverter"/>
        <converters:EventDurationToHeightConverter x:Key="DurationToHeightConverter"/>
        <converters:WidthFractionToWidthConverter x:Key="WidthFractionConverter"/>
        <converters:LeftFractionToLeftConverter x:Key="LeftFractionConverter"/>
        <converters:StringToVisibilityConverter x:Key="StringToVisibilityConverter"/>
    </UserControl.Resources>
    
    <Grid Background="#F0F0F0">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        
        <!-- Верхняя панель инструментов -->
        <Border Grid.Row="0"
                Background="{StaticResource ToolbarGradient}"
                BorderBrush="{StaticResource BorderGray}"
                BorderThickness="0,0,0,1"
                Padding="8,4">
            <StackPanel Orientation="Horizontal">
                <RadioButton Content="День"
                             Margin="0,0,2,0"
                             Padding="10,4"
                             GroupName="View"
                             Command="{Binding SetViewModeCommand}"
                             CommandParameter="{x:Static vm:CalendarViewMode.Day}"/>
                <RadioButton Content="Неделя"
                             IsChecked="True"
                             Margin="0,0,2,0"
                             Padding="10,4"
                             GroupName="View"
                             Command="{Binding SetViewModeCommand}"
                             CommandParameter="{x:Static vm:CalendarViewMode.WorkWeek}"/>
                <RadioButton Content="Месяц"
                             Padding="10,4"
                             GroupName="View"
                             Command="{Binding SetViewModeCommand}"
                             CommandParameter="{x:Static vm:CalendarViewMode.Month}"/>

                <Separator Margin="15,0"/>

                <RadioButton Content="Показывать рабочую неделю"
                             IsChecked="{Binding ShowWorkWeekOnly, Mode=TwoWay}"
                             Margin="0,0,10,0"
                             GroupName="WeekMode"/>
                <RadioButton Content="Показывать полную неделю"
                             IsChecked="{Binding ShowWorkWeekOnly, Mode=TwoWay, Converter={StaticResource InverseBoolConverter}}"
                             GroupName="WeekMode"/>
            </StackPanel>
        </Border>
        
        <!-- Панель навигации -->
        <Border Grid.Row="1"
                Background="White"
                BorderBrush="{StaticResource BorderGray}"
                BorderThickness="0,0,0,1"
                Padding="8,6">
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                <Button Content="◀" Width="24" Height="24" Command="{Binding PreviousWeekCommand}" Margin="0,0,2,0"/>
                <Button Content="▶" Width="24" Height="24" Command="{Binding NextWeekCommand}"/>
                <TextBlock Text="{Binding PeriodTitle}" 
                           FontSize="16" 
                           FontWeight="SemiBold"
                           Margin="12,0,0,0"
                           VerticalAlignment="Center"/>
            </StackPanel>
        </Border>
        
        <!-- Основная область календаря -->
        <Grid Grid.Row="2">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Overlay Canvas для drag ghost (поверх всего контента) -->
            <Canvas x:Name="DragOverlayCanvas"
                    Grid.RowSpan="3"
                    Panel.ZIndex="1000"
                    IsHitTestVisible="False"/>
            
            <!-- Заголовки дней -->
            <Grid Grid.Row="0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="50"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                
                <Border Grid.Column="0" 
                        Background="{StaticResource HeaderGradient}"
                        BorderBrush="{StaticResource BorderGray}"
                        BorderThickness="0,0,1,1"
                        Height="40"/>
                
                <ItemsControl Grid.Column="1" ItemsSource="{Binding Days}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <UniformGrid Rows="1"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Background="{StaticResource HeaderGradient}"
                                    BorderBrush="{StaticResource BorderGray}"
                                    BorderThickness="0,0,1,1"
                                    Height="40">
                                <StackPanel Orientation="Horizontal" 
                                            HorizontalAlignment="Center" 
                                            VerticalAlignment="Center">
                                    <TextBlock Text="{Binding DayNumber}" 
                                               FontSize="14" 
                                               FontWeight="Bold"
                                               Foreground="#333"/>
                                    <TextBlock Text="{Binding DayOfWeekShort}" 
                                               FontSize="14" 
                                               Margin="6,0,0,0"
                                               Foreground="#666"/>
                                </StackPanel>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Grid>
            
            <!-- Многодневные события -->
            <Grid Grid.Row="1" MinHeight="30">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="50"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                
                <Border Grid.Column="0" 
                        Background="White"
                        BorderBrush="{StaticResource BorderGray}"
                        BorderThickness="0,0,1,1"/>
                
                <Border Grid.Column="1"
                        Background="White"
                        BorderBrush="{StaticResource BorderGray}"
                        BorderThickness="0,0,0,1"
                        Padding="4,4">
                    <ItemsControl ItemsSource="{Binding MultiDayEvents}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="#FFA500"
                                        CornerRadius="2"
                                        Padding="6,2"
                                        Margin="0,1">
                                    <TextBlock Text="{Binding Title}"
                                               Foreground="White"
                                               FontWeight="SemiBold"
                                               FontSize="11"/>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </Border>
            </Grid>
            
            <!-- Сетка календаря -->
            <ScrollViewer Grid.Row="2" 
                          VerticalScrollBarVisibility="Auto"
                          HorizontalScrollBarVisibility="Disabled">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="50"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Временная шкала -->
                    <ItemsControl Grid.Column="0" ItemsSource="{Binding Hours}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Height="60"
                                        BorderBrush="{StaticResource GridLine}"
                                        BorderThickness="0,0,1,1"
                                        Background="White">
                                    <TextBlock Text="{Binding StringFormat='{}{0}:00'}"
                                               FontSize="10"
                                               Foreground="#666"
                                               Margin="4,2,4,0"
                                               HorizontalAlignment="Right"/>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                    
                    <!-- Колонки дней -->
                    <ItemsControl x:Name="DaysItemsControl" Grid.Column="1" ItemsSource="{Binding Days}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <UniformGrid Rows="1"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Grid Background="Transparent"
                                      MouseLeftButtonDown="DayGrid_MouseLeftButtonDown">
                                    <!-- Фон с сеткой -->
                                    <ItemsControl ItemsSource="{Binding DataContext.Hours, RelativeSource={RelativeSource AncestorType=UserControl}}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <StackPanel/>
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border Height="60"
                                                        BorderBrush="{StaticResource GridLine}"
                                                        BorderThickness="0,0,1,1"
                                                        Background="White"/>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                    
                                    <!-- События дня -->
                                    <ItemsControl x:Name="EventsItemsControl"
                                                  ItemsSource="{Binding EventLayouts}"
                                                  Margin="2,0">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <Canvas/>
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemContainerStyle>
                                            <Style TargetType="ContentPresenter">
                                                <Setter Property="Canvas.Top">
                                                    <Setter.Value>
                                                        <MultiBinding Converter="{StaticResource TimeToCanvasTopConverter}">
                                                            <Binding Path="Event.StartTime"/>
                                                        </MultiBinding>
                                                    </Setter.Value>
                                                </Setter>
                                                <Setter Property="Canvas.Left">
                                                    <Setter.Value>
                                                        <MultiBinding Converter="{StaticResource LeftFractionConverter}">
                                                            <Binding Path="LeftFraction"/>
                                                            <Binding Path="ActualWidth"
                                                                     RelativeSource="{RelativeSource AncestorType=ItemsControl}"/>
                                                        </MultiBinding>
                                                    </Setter.Value>
                                                </Setter>
                                            </Style>
                                        </ItemsControl.ItemContainerStyle>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border CornerRadius="3"
                                                        Padding="4,2"
                                                        Margin="0,0,2,0"
                                                        Cursor="Hand"
                                                        behaviors:DoubleClickBehavior.Command="{Binding DataContext.EditEventCommand,
                                                            RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                        behaviors:DoubleClickBehavior.CommandParameter="{Binding Event}"
                                                        PreviewMouseDown="EventBorder_PreviewMouseDown"
                                                        MouseMove="EventBorder_MouseMove"
                                                        PreviewMouseUp="EventBorder_PreviewMouseUp"
                                                        LostMouseCapture="EventBorder_LostMouseCapture">
                                                    <Border.Width>
                                                        <MultiBinding Converter="{StaticResource WidthFractionConverter}">
                                                            <Binding Path="WidthFraction"/>
                                                            <Binding Path="ActualWidth"
                                                                     RelativeSource="{RelativeSource AncestorType=ItemsControl}"/>
                                                        </MultiBinding>
                                                    </Border.Width>
                                                    <Border.Height>
                                                        <MultiBinding Converter="{StaticResource DurationToHeightConverter}">
                                                            <Binding Path="Event.StartTime"/>
                                                            <Binding Path="Event.EndTime"/>
                                                        </MultiBinding>
                                                    </Border.Height>
                                                    <Border.Style>
                                                        <Style TargetType="Border">
                                                            <Setter Property="Background" Value="#90EE90"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding Event.Category}" Value="Important">
                                                                    <Setter Property="Background" Value="#FF6347"/>
                                                                </DataTrigger>
                                                                <DataTrigger Binding="{Binding Event.Category}" Value="Business">
                                                                    <Setter Property="Background" Value="#6495ED"/>
                                                                </DataTrigger>
                                                                <DataTrigger Binding="{Binding Event.Category}" Value="Meeting">
                                                                    <Setter Property="Background" Value="#FFFF96"/>
                                                                </DataTrigger>
                                                                <DataTrigger Binding="{Binding Event.Category}" Value="Travel">
                                                                    <Setter Property="Background" Value="#ADD8E6"/>
                                                                </DataTrigger>
                                                                <DataTrigger Binding="{Binding Event.Category}" Value="Holiday">
                                                                    <Setter Property="Background" Value="#FFA500"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Border.Style>
                                                    <StackPanel>
                                                        <TextBlock Text="{Binding Event.Title}"
                                                                   FontWeight="SemiBold"
                                                                   FontSize="11"
                                                                   TextWrapping="Wrap"
                                                                   Foreground="#333"/>
                                                        <TextBlock FontSize="10" Foreground="#555">
                                                            <Run Text="{Binding Event.StartTime, StringFormat='{}{0:HH:mm}', Mode=OneWay}"/>
                                                            <Run Text=" - "/>
                                                            <Run Text="{Binding Event.EndTime, StringFormat='{}{0:HH:mm}', Mode=OneWay}"/>
                                                        </TextBlock>
                                                        <TextBlock Text="{Binding Event.Description}"
                                                                   FontSize="10"
                                                                   FontStyle="Italic"
                                                                   Foreground="#555"
                                                                   TextWrapping="Wrap"
                                                                   Visibility="{Binding Event.Description,
                                                                       Converter={StaticResource StringToVisibilityConverter},
                                                                       FallbackValue=Collapsed}"/>
                                                    </StackPanel>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </Grid>
            </ScrollViewer>
        </Grid>
        
    </Grid>
</UserControl>
