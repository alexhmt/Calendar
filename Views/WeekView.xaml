<UserControl x:Class="OutlookCalendar.Views.WeekView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:vm="clr-namespace:OutlookCalendar.ViewModels"
             xmlns:controls="clr-namespace:OutlookCalendar.Controls"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="900"
             d:DataContext="{d:DesignInstance vm:WeekViewModel}">
    
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Styles/CalendarStyles.xaml"/>
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </UserControl.Resources>
    
    <Grid Background="#F0F0F0">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="Auto"/>
        </Grid.ColumnDefinitions>
        
        <!-- Верхняя панель инструментов -->
        <Border Grid.Row="0" Grid.ColumnSpan="2"
                Background="{StaticResource ToolbarGradient}"
                BorderBrush="{StaticResource OutlookBorderGrayBrush}"
                BorderThickness="0,0,0,1"
                Padding="8,4">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <!-- Кнопки переключения вида -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <RadioButton Content="День" 
                                 Style="{StaticResource ViewModeButtonStyle}"
                                 IsChecked="{Binding ViewMode, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Day}"
                                 GroupName="ViewMode"/>
                    <RadioButton Content="Неделя" 
                                 Style="{StaticResource ViewModeButtonStyle}"
                                 IsChecked="True"
                                 GroupName="ViewMode"
                                 Margin="-1,0,0,0"/>
                    <RadioButton Content="Месяц" 
                                 Style="{StaticResource ViewModeButtonStyle}"
                                 GroupName="ViewMode"
                                 Margin="-1,0,0,0"/>
                </StackPanel>
                
                <!-- Переключатели рабочая/полная неделя -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="20,0,0,0">
                    <RadioButton Content="Показывать рабочую неделю"
                                 Style="{StaticResource WeekModeRadioStyle}"
                                 IsChecked="{Binding ShowWorkWeekOnly}"
                                 GroupName="WeekMode"/>
                    <RadioButton Content="Показывать полную неделю"
                                 Style="{StaticResource WeekModeRadioStyle}"
                                 IsChecked="{Binding ShowWorkWeekOnly, Converter={StaticResource InverseBoolToVisibilityConverter}}"
                                 GroupName="WeekMode"/>
                </StackPanel>
                
                <!-- Поле поиска -->
                <StackPanel Grid.Column="3" Orientation="Horizontal">
                    <TextBox Width="150" 
                             Style="{StaticResource SearchBoxStyle}"
                             Text="{Binding SearchQuery, UpdateSourceTrigger=PropertyChanged}">
                        <TextBox.Style>
                            <Style TargetType="TextBox" BasedOn="{StaticResource SearchBoxStyle}">
                                <Style.Triggers>
                                    <Trigger Property="Text" Value="">
                                        <Setter Property="Background">
                                            <Setter.Value>
                                                <VisualBrush Stretch="None" AlignmentX="Left">
                                                    <VisualBrush.Visual>
                                                        <TextBlock Text="Поиск Календарь" 
                                                                   Foreground="Gray" 
                                                                   Margin="5,0,0,0"/>
                                                    </VisualBrush.Visual>
                                                </VisualBrush>
                                            </Setter.Value>
                                        </Setter>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </TextBox.Style>
                    </TextBox>
                    <ComboBox Width="25" Height="22" Margin="-1,0,0,0"/>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- Панель навигации по датам -->
        <Border Grid.Row="1" Grid.ColumnSpan="2"
                Background="White"
                BorderBrush="{StaticResource OutlookBorderGrayBrush}"
                BorderThickness="0,0,0,1"
                Padding="8,6">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                
                <!-- Кнопки навигации и заголовок периода -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <Button Style="{StaticResource NavButtonStyle}"
                            Command="{Binding PreviousWeekCommand}"
                            ToolTip="Предыдущая неделя">
                        <TextBlock Text="◀" FontSize="10"/>
                    </Button>
                    <Button Style="{StaticResource NavButtonStyle}"
                            Command="{Binding NextWeekCommand}"
                            Margin="2,0,0,0"
                            ToolTip="Следующая неделя">
                        <TextBlock Text="▶" FontSize="10"/>
                    </Button>
                    <TextBlock Text="{Binding PeriodTitle}" 
                               FontSize="16" 
                               FontWeight="SemiBold"
                               Margin="12,0,0,0"
                               VerticalAlignment="Center"/>
                </StackPanel>
                
                <!-- Ссылка на включение поиска -->
                <TextBlock Grid.Column="1" 
                           HorizontalAlignment="Left"
                           Margin="20,0,0,0"
                           VerticalAlignment="Center">
                    <Hyperlink>Нажмите эту ссылку для включения мгновенного поиска</Hyperlink>
                </TextBlock>
            </Grid>
        </Border>
        
        <!-- Основная область календаря -->
        <Grid Grid.Row="2" Grid.Column="0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            
            <!-- Заголовки дней -->
            <Grid Grid.Row="0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="50"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                
                <!-- Пустой угол слева -->
                <Border Grid.Column="0" 
                        Background="{StaticResource HeaderGradient}"
                        BorderBrush="{StaticResource OutlookBorderGrayBrush}"
                        BorderThickness="0,0,1,1"/>
                
                <!-- Заголовки дней -->
                <ItemsControl Grid.Column="1" ItemsSource="{Binding Days}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <UniformGrid Rows="1"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Style="{StaticResource DayHeaderStyle}">
                                <Border.Background>
                                    <MultiBinding Converter="{StaticResource BoolToVisibilityConverter}">
                                        <Binding Path="IsWeekend"/>
                                    </MultiBinding>
                                </Border.Background>
                                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                        <TextBlock Text="{Binding DayNumber}" 
                                                   FontSize="14" 
                                                   FontWeight="Bold"
                                                   Foreground="#333"/>
                                        <TextBlock Text="{Binding DayOfWeekShort}" 
                                                   FontSize="14" 
                                                   Margin="6,0,0,0"
                                                   Foreground="#666"/>
                                    </StackPanel>
                                </StackPanel>
                                <!-- Индикатор "сегодня" -->
                                <Border.Style>
                                    <Style TargetType="Border" BasedOn="{StaticResource DayHeaderStyle}">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsToday}" Value="True">
                                                <Setter Property="BorderBrush" Value="{StaticResource OutlookTodayBorderBrush}"/>
                                                <Setter Property="BorderThickness" Value="2"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding IsWeekend}" Value="True">
                                                <Setter Property="Background" Value="{StaticResource OutlookWeekendBgBrush}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Grid>
            
            <!-- Многодневные события -->
            <Grid Grid.Row="1" MinHeight="26">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="50"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                
                <Border Grid.Column="0" 
                        Background="White"
                        BorderBrush="{StaticResource OutlookBorderGrayBrush}"
                        BorderThickness="0,0,1,1"/>
                
                <Border Grid.Column="1"
                        Background="White"
                        BorderBrush="{StaticResource OutlookBorderGrayBrush}"
                        BorderThickness="0,0,0,1">
                    <ItemsControl ItemsSource="{Binding MultiDayEvents}" Margin="4,2">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Style="{StaticResource MultiDayEventStyle}"
                                        Background="{Binding Category, Converter={StaticResource CategoryToBackgroundConverter}}"
                                        BorderBrush="{Binding Category, Converter={StaticResource CategoryToBackgroundConverter}}">
                                    <TextBlock Text="{Binding Title}"
                                               Foreground="{Binding Category, Converter={StaticResource CategoryToForegroundConverter}}"
                                               FontWeight="SemiBold"
                                               FontSize="11"
                                               VerticalAlignment="Center"
                                               TextTrimming="CharacterEllipsis"/>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </Border>
            </Grid>
            
            <!-- Сетка календаря с временными слотами -->
            <ScrollViewer Grid.Row="2" 
                          VerticalScrollBarVisibility="Auto"
                          HorizontalScrollBarVisibility="Disabled">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="50"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Временная шкала слева -->
                    <ItemsControl Grid.Column="0" ItemsSource="{Binding Hours}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Height="{Binding DataContext.HourHeight, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                        BorderBrush="{StaticResource OutlookGridLineBrush}"
                                        BorderThickness="0,0,1,1"
                                        Background="White">
                                    <TextBlock Text="{Binding StringFormat='{}{0}:00'}"
                                               FontSize="10"
                                               Foreground="#666"
                                               Margin="4,0,4,0"
                                               VerticalAlignment="Top"
                                               HorizontalAlignment="Right"/>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                    
                    <!-- Колонки дней с событиями -->
                    <ItemsControl Grid.Column="1" ItemsSource="{Binding Days}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <UniformGrid Rows="1"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Grid>
                                    <!-- Фон с сеткой часов -->
                                    <ItemsControl ItemsSource="{Binding DataContext.Hours, RelativeSource={RelativeSource AncestorType=UserControl}}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <StackPanel/>
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border Height="{Binding DataContext.HourHeight, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                        Style="{StaticResource TimeSlotStyle}">
                                                    <Border.Style>
                                                        <Style TargetType="Border" BasedOn="{StaticResource TimeSlotStyle}">
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding DataContext.IsWeekend, RelativeSource={RelativeSource AncestorType=Grid}}" Value="True">
                                                                    <Setter Property="Background" Value="{StaticResource OutlookWeekendBgBrush}"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Border.Style>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                    
                                    <!-- События дня (позиционируются абсолютно) -->
                                    <ItemsControl ItemsSource="{Binding Events}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <Canvas/>
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemContainerStyle>
                                            <Style TargetType="ContentPresenter">
                                                <Setter Property="Canvas.Top" Value="{Binding StartTime, Converter={StaticResource TimeToTopConverter}}"/>
                                                <Setter Property="Width" Value="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=ItemsControl}, Converter={StaticResource DurationToHeightConverter}, ConverterParameter=0.95}"/>
                                            </Style>
                                        </ItemsControl.ItemContainerStyle>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <controls:EventControl 
                                                    DataContext="{Binding}"
                                                    Height="{Binding Duration, Converter={StaticResource DurationToHeightConverter}}"
                                                    Margin="2,0,4,0"/>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </Grid>
            </ScrollViewer>
        </Grid>
        
        <!-- Правая боковая панель -->
        <Border Grid.Row="2" Grid.Column="1" 
                Style="{StaticResource SidePanelStyle}"
                Width="25">
            <Grid>
                <!-- Вкладка "Список дел" -->
                <Border Style="{StaticResource SideTabStyle}"
                        VerticalAlignment="Top"
                        Margin="0,20,0,0">
                    <TextBlock Text="Список дел"
                               FontSize="10"
                               Foreground="#333">
                        <TextBlock.LayoutTransform>
                            <RotateTransform Angle="90"/>
                        </TextBlock.LayoutTransform>
                    </TextBlock>
                </Border>
                
                <!-- Вкладка "Задачи сегодня" -->
                <Border Style="{StaticResource SideTabStyle}"
                        VerticalAlignment="Top"
                        Margin="0,120,0,0">
                    <TextBlock Text="Задачи сегодня"
                               FontSize="10"
                               Foreground="#333">
                        <TextBlock.LayoutTransform>
                            <RotateTransform Angle="90"/>
                        </TextBlock.LayoutTransform>
                    </TextBlock>
                </Border>
            </Grid>
        </Border>
        
        <!-- Нижняя панель задач -->
        <Border Grid.Row="3" Grid.ColumnSpan="2"
                Background="White"
                BorderBrush="{StaticResource OutlookBorderGrayBrush}"
                BorderThickness="0,1,0,0"
                MaxHeight="150">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                
                <!-- Заголовок панели задач -->
                <Border Grid.Row="0" 
                        Background="{StaticResource ToolbarGradient}"
                        BorderBrush="{StaticResource OutlookBorderGrayBrush}"
                        BorderThickness="0,0,0,1"
                        Padding="8,4">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        
                        <TextBlock Grid.Column="0" 
                                   Text="Задачи"
                                   FontWeight="Bold"
                                   VerticalAlignment="Center">
                            <TextBlock.LayoutTransform>
                                <RotateTransform Angle="-90"/>
                            </TextBlock.LayoutTransform>
                        </TextBlock>
                        
                        <TextBlock Grid.Column="1" 
                                   Text="Показывать задачи по: Срок"
                                   Margin="8,0,0,0"
                                   VerticalAlignment="Center"
                                   Foreground="#666"/>
                    </Grid>
                </Border>
                
                <!-- Список задач -->
                <ScrollViewer Grid.Row="1" 
                              VerticalScrollBarVisibility="Auto"
                              MaxHeight="100">
                    <ItemsControl ItemsSource="{Binding Tasks}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <UniformGrid Columns="3"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Style="{StaticResource TaskItemStyle}">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <CheckBox Grid.Column="0"
                                                  Style="{StaticResource TaskCheckBoxStyle}"
                                                  IsChecked="{Binding IsCompleted}"/>
                                        
                                        <TextBlock Grid.Column="1"
                                                   Text="{Binding Title}"
                                                   TextTrimming="CharacterEllipsis"
                                                   VerticalAlignment="Center"
                                                   TextDecorations="{Binding Status, Converter={StaticResource TaskStatusToStrikethroughConverter}}"/>
                                        
                                        <Border Grid.Column="2"
                                                Width="8" Height="8"
                                                CornerRadius="4"
                                                Margin="4,0,0,0"
                                                Background="{Binding Priority, Converter={StaticResource PriorityToColorConverter}}"
                                                VerticalAlignment="Center"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>
        </Border>
    </Grid>
</UserControl>
